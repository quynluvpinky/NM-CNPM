-- Xóa bảng nếu tồn tại
DROP TABLE IF EXISTS CHITIETPHANAN, SANPHAMXUATKHO, CHITIETNHAPKHO, SANPHAMTONKHO, LOAISANPHAM, NHACUNGUNG, DOANHTHU, MONAN, SODIENTHOAINCU;

-- Tạo bảng MONAN
CREATE TABLE MONAN (
    MAMON CHAR(4) PRIMARY KEY,
    TENMON VARCHAR(30)
);

-- Tạo bảng DOANHTHU
CREATE TABLE DOANHTHU (
    NGAY DATE PRIMARY KEY,
    TONGTIEN DOUBLE PRECISION
);

-- Tạo bảng NHACUNGUNG
CREATE TABLE NHACUNGUNG (
    MANCU CHAR(4) PRIMARY KEY,
    TENNCU VARCHAR(30),
    DIACHI VARCHAR(30)
);

-- Tạo bảng LOAISANPHAM
CREATE TABLE LOAISANPHAM (
    MALOAI CHAR(4) PRIMARY KEY,
    TENLOAI VARCHAR(30)
);

-- Tạo bảng SODIENTHOAINCU
CREATE TABLE SODIENTHOAINCU (
    MANCU CHAR(4),
    SODIENTHOAI CHAR(10),
    PRIMARY KEY (MANCU, SODIENTHOAI),
    FOREIGN KEY (MANCU) REFERENCES NHACUNGUNG(MANCU)
);

-- Tạo bảng SANPHAMTONKHO
CREATE TABLE SANPHAMTONKHO (
    MASANPHAM CHAR(4) PRIMARY KEY,
    TENSANPHAM VARCHAR(30),
    SOLUONG INT,
    GIACA DOUBLE PRECISION,
    LOAISANPHAM CHAR(4),
    FOREIGN KEY (LOAISANPHAM) REFERENCES LOAISANPHAM(MALOAI)
);

-- Tạo bảng CHITIETNHAPKHO
CREATE TABLE CHITIETNHAPKHO (
    MANCU CHAR(4),
    MASANPHAM CHAR(4),
    NGAYNHAP DATE,
    SOLUONG INT,
    PRIMARY KEY (MANCU, MASANPHAM),
    FOREIGN KEY (MANCU) REFERENCES NHACUNGUNG(MANCU),
    FOREIGN KEY (MASANPHAM) REFERENCES SANPHAMTONKHO(MASANPHAM)
);

-- Tạo bảng SANPHAMXUATKHO
CREATE TABLE SANPHAMXUATKHO (
    MASANPHAM CHAR(4),
    NGAY DATE,
    SOLUONGSANPHAM INT,
    PRIMARY KEY (MASANPHAM, NGAY),
    FOREIGN KEY (MASANPHAM) REFERENCES SANPHAMTONKHO(MASANPHAM),
    FOREIGN KEY (NGAY) REFERENCES DOANHTHU(NGAY)
);

-- Tạo bảng CHITIETPHANAN
CREATE TABLE CHITIETPHANAN (
    NGAY DATE,
    MAMON CHAR(4),
    SOLUONGMON INT,
    PRIMARY KEY (NGAY, MAMON),
    FOREIGN KEY (NGAY) REFERENCES DOANHTHU(NGAY),
    FOREIGN KEY (MAMON) REFERENCES MONAN(MAMON)
);

-- Tạo trigger UpdateTongTienOnChiTietPhanAn
CREATE OR REPLACE FUNCTION update_tongtien_chitietphanan() RETURNS TRIGGER AS $$
BEGIN
    UPDATE DOANHTHU
    SET TONGTIEN = TONGTIEN + (NEW.SOLUONGMON * 25)
    WHERE DOANHTHU.NGAY = NEW.NGAY;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER UpdateTongTienOnChiTietPhanAn
AFTER INSERT
ON CHITIETPHANAN
FOR EACH ROW
EXECUTE FUNCTION update_tongtien_chitietphanan();

-- Tạo trigger UpdateTongTienOnSanPhamXuatKho
CREATE OR REPLACE FUNCTION update_tongtien_sanphamxuatkho() RETURNS TRIGGER AS $$
BEGIN
    UPDATE DOANHTHU
    SET TONGTIEN = TONGTIEN + (NEW.SOLUONGSANPHAM * SP.GIACA)
    FROM SANPHAMTONKHO SP
    WHERE DOANHTHU.NGAY = NEW.NGAY AND SP.MASANPHAM = NEW.MASANPHAM;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER UpdateTongTienOnSanPhamXuatKho
AFTER INSERT
ON SANPHAMXUATKHO
FOR EACH ROW
EXECUTE FUNCTION update_tongtien_sanphamxuatkho();
