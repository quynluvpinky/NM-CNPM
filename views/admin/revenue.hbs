<head>
    <link rel="stylesheet" href="css/revenue.css">
</head>
<main>
    <div class="container d-fluid">
        <label class="switch">
            <input type="checkbox" class="toggle" name="toggle-label" />
            <label class="form-label" for="toggle-label"><strong>Báo cáo ngày/tháng</strong></label>
            <span class="slider"></span>

            <div class="flip-card__inner mt-3">
                <div class="flip-card__front">
                    <div class="title">Báo cáo doanh thu ngày</div>
                    <div class="d-flex align-items-center">
                        <label for="date"><strong>Nhập ngày:</strong></label>
                        <input id="date"type="date"class="form-control mx-3"name="date" />
                        <button type="button" class="btn btn-primary" onclick="fetchRevenueByDate()">Load</button>
                    </div>

                    <table class="table table-striped m-0">
                        <thead>
                            <tr class="table-dark">
                                <th scope="col" width="10%">Mã sản phẩm</th>
                                <th scope="col" width="30%">Tên sản phẩm</th>
                                <th scope="col" width="10%">Đơn giá</th>
                                <th scope="col" width="10%">Số lượng</th>
                                <th scope="col"class="text-end"width="10%"><span>Thành tiền</span></th>
                            </tr>
                        </thead> 
                        <tbody id="revenueByDateTable"></tbody>
                    </table>
                    <div id="errorMsgFront" class="">Không có dữ liệu</div>
                    <strong id="totalRevenueDate">Tổng doanh thu ngày:</strong>
                </div>
                <div class="flip-card__back">
                    <div class="title">Báo cáo doanh thu tháng</div>
                    <div action="" class="d-flex align-items-center">
                        <label for="month"><strong>Nhập tháng:</strong></label>
                        <input id="month" type="month" placeholder="mm-yyyy" class="form-control mx-3" name="month"/>
                        <button type="button" class="btn btn-primary" onclick="fetchRevenueByMonth()">Load</button>
                    </div>

                    <table class="table table-striped m-0">
                        <thead>
                            <tr class="table-dark">
                                <th scope="col" width="70%">Ngày</th>
                                <th scope="col" width="30%" class="text-end"><span>Doanh thu</span></th>
                            </tr>
                        </thead>
                        <tbody id="revenueByMonthTable"></tbody>
                    </table>
                    <div id="errorMsgBack" class="">Không có dữ liệu</div>
                    <strong id="totalRevenueMonth">Tổng doanh thu tháng:</strong>
                </div>
            </div>
        </label>
    </div>
</main>
<script>
    function fetchRevenueByDate() {
        // Lấy giá trị từ ô input
        var inputDate = document.getElementById('date').value;
        fetch(`/data/revenue/by-date?date=${inputDate}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        console.log(data.error);
                        throw new Error(data.error);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Xử lý dữ liệu và cập nhật giao diện
                updateRevenueByDateTable(data);
                updateTotalRevenueByDate(data);
            })
            .catch(error => {
                alert(error.message);
            });
    }

    function updateRevenueByDateTable(data) {
        // Lấy phần tử tbody của bảng
        var tbody = document.getElementById('revenueByDateTable');

        // Xóa nội dung hiện tại của tbody
        tbody.innerHTML = '';

        // thông báo không có dữ liệu
        var errorMsgElement = document.getElementById('errorMsgFront');
        if (data.length !== 0) {
            errorMsgElement.classList.add('d-none');
        } else {
            errorMsgElement.classList.remove('d-none');
        }

        // Lặp qua dữ liệu và thêm các dòng mới vào tbody
        data.forEach(item => {
            var row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.itemid}</td>
                <td>${item.name}</td>
                <td>${item.price}</td>
                <td>${item.quantity}</td>
                <td class="text-end"><span class="fw-bolder">${item.total}</span></td>
            `;
            tbody.appendChild(row);
        });
    }

    function updateTotalRevenueByDate(data) {
        // Tính tổng doanh thu từ dữ liệu mới
        var totalRevenue = data.reduce((sum, item) => sum + Number(item.total), 0);

        // Cập nhật tổng doanh thu
        var totalRevenueElement = document.getElementById('totalRevenueDate');
        totalRevenueElement.innerText = `Tổng doanh thu ngày: ${totalRevenue}`;
    }

    function fetchRevenueByMonth() {
            // Lấy giá trị từ ô input
            var inputMonth = document.getElementById('month').value;
            fetch(`/data/revenue/by-month?month=${inputMonth}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            console.log(data.error);
                            throw new Error(data.error);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Xử lý dữ liệu và cập nhật giao diện
                    updateRevenueByMonthTable(data);
                    updateTotalRevenueByMonth(data);
                })
                .catch(error => {
                    alert(error.message);
                });
        }

    function updateRevenueByMonthTable(data) {
        // Lấy phần tử tbody của bảng
        var tbody = document.getElementById('revenueByMonthTable');

        // Xóa nội dung hiện tại của tbody
        tbody.innerHTML = '';

        // thông báo không có dữ liệu
        var errorMsgElement = document.getElementById('errorMsgBack');
        if (data.length !== 0) {
            errorMsgElement.classList.add('d-none');
        } else {
            errorMsgElement.classList.remove('d-none');
        }

        // Lặp qua dữ liệu và thêm các dòng mới vào tbody
        data.forEach(item => {
            var row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.date}</td>
                <td class="text-end"><span class="fw-bolder">${item.total}</span></td>
            `;
            tbody.appendChild(row);
        });
    }

    function updateTotalRevenueByMonth(data) {
        // Tính tổng doanh thu từ dữ liệu mới
        var totalRevenue = data.reduce((sum, item) => sum + Number(item.total), 0);

        // Cập nhật tổng doanh thu
        var totalRevenueElement = document.getElementById('totalRevenueMonth');
        totalRevenueElement.innerText = `Tổng doanh thu tháng: ${totalRevenue}`;
    }
        
</script>